name: Deploy Infrastructure

on:
  push:
    branches:
      - master
      - main
  workflow_run:
    workflows: ["Build and Push Habits API Image"]
    types:
      - completed
  workflow_dispatch:

env:
  PROJECT_DIR: /root/project
  DEPLOY_DIR: deployment

jobs:
  deploy:
    runs-on: ubuntu-latest    
    steps:
      - name: Checkout deployment repository
        uses: actions/checkout@v3
        with:
          repository: andreyDanilenko/deployment-automation
          path: deployment
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_SECRET_KEY }}
          script: |
            echo "=== Starting deployment with Docker images ==="
            
            # Создаем основную папку проекта
            mkdir -p ${{ env.PROJECT_DIR }}/${{ env.DEPLOY_DIR }}
            cd ${{ env.PROJECT_DIR }}/${{ env.DEPLOY_DIR }}
            
            # Обновляем deployment файлы
            echo "=== Updating deployment configuration ==="
            if [ ! -d ".git" ]; then
              echo "❌ Cloning deployment repository..."
              git clone https://github.com/andreyDanilenko/deployment-automation.git .
            else
              echo "✅ Updating deployment repository..."
              git pull origin master 2>/dev/null || git pull origin main
            fi
            
            # Сохраняем .env если есть
            if [ -f ".env" ]; then
              cp .env /tmp/.env.backup
              echo "✅ .env file saved"
            fi
            
            # Загружаем последние изменения
            git fetch --all
            git reset --hard origin/master 2>/dev/null || git reset --hard origin/main
            
            # Восстанавливаем .env
            if [ -f "/tmp/.env.backup" ]; then
              mv /tmp/.env.backup .env
              echo "✅ .env file restored"
            fi
            
            # Возвращаемся в папку deployment для запуска контейнеров
            cd ${{ env.PROJECT_DIR }}/${{ env.DEPLOY_DIR }}
            
            # Тянем ВСЕ образы
            echo "=== Pulling latest Docker images ==="
            docker-compose pull habits_api
            docker-compose pull habits_frontend
            docker-compose pull article_app
            docker-compose pull article_frontend
            
            # Перезапускаем контейнеры
            echo "=== Recreating containers ==="
            docker-compose down
            export DOCKER_BUILDKIT=1
            docker-compose up -d --build
            
            # Проверки
            echo "=== Checking containers status ==="
            docker-compose ps
            
            echo "=== Checking service availability ==="
            echo "Article Service:"
            curl -I https://lifedream.tech || echo "Not available"
            
            echo "Habits Service:"
            curl -I https://habits.lifedream.tech/api/health || echo "⚠️ Health check failed"
            
            echo "=== Checking volumes ==="
            docker volume ls | grep postgres_data
            
            echo "=== Deployment completed ==="
