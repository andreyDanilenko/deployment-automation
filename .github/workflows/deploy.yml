name: Deploy Infrastructure

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  PROJECT_DIR: /root/project
  DEPLOY_DIR: deployment
  API_DIR: habits-api
  CLIENT_DIR: habits
  GO_ANGULAR_DIR: go-angular-pg

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_SECRET_KEY }}
          script: |
            echo "=== –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è ==="
            
            # –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            if [ ! -d "${{ env.PROJECT_DIR }}" ]; then
              echo "üìÅ –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ ${{ env.PROJECT_DIR }}"
              mkdir -p ${{ env.PROJECT_DIR }}
            fi
            
            # –°–æ–∑–¥–∞–µ–º –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É deployment
            echo "=== –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π deployment ==="
            mkdir -p ${{ env.PROJECT_DIR }}/${{ env.DEPLOY_DIR }}
            cd ${{ env.PROJECT_DIR }}/${{ env.DEPLOY_DIR }}
            
            # –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –ø—É—Å—Ç–∞—è - –∫–ª–æ–Ω–∏—Ä—É–µ–º
            if [ ! -d ".git" ]; then
              echo "‚ùå Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –ö–ª–æ–Ω–∏—Ä—É–µ–º..."
              git clone https://github.com/andreyDanilenko/deployment-automation.git .
            else
              echo "‚úÖ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–ª—è–µ–º..."
              # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –≤ git
              if [ -f ".env" ]; then
                cp .env /tmp/.env.backup
                echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω"
              fi
              
              git fetch --all
              git reset --hard origin/master 2>/dev/null || git reset --hard origin/main
              git pull origin master 2>/dev/null || git pull origin/main
              
              # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env –µ—Å–ª–∏ –±—ã–ª
              if [ -f "/tmp/.env.backup" ]; then
                mv /tmp/.env.backup .env
                echo "‚úÖ .env —Ñ–∞–π–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
              fi
            fi
            
            echo "=== –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è ==="
            git log --oneline -3
            
            echo "=== –û–±–Ω–æ–≤–ª—è–µ–º habits-api —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ==="
            mkdir -p ${{ env.PROJECT_DIR }}/${{ env.API_DIR }}
            cd ${{ env.PROJECT_DIR }}/${{ env.API_DIR }}
            if [ ! -d ".git" ]; then
              echo "‚ùå –ö–ª–æ–Ω–∏—Ä—É–µ–º habits-api..."
              git clone https://github.com/andreyDanilenko/habits-api.git .
            else
              echo "‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º habits-api..."
              git fetch --all
              git reset --hard origin/master 2>/dev/null || git reset --hard origin/main
              git pull origin master 2>/dev/null || git pull origin/main
            fi
            
            echo "=== –û–±–Ω–æ–≤–ª—è–µ–º habits-client —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ==="
            mkdir -p ${{ env.PROJECT_DIR }}/${{ env.CLIENT_DIR }}
            cd ${{ env.PROJECT_DIR }}/${{ env.CLIENT_DIR }}
            if [ ! -d ".git" ]; then
              echo "‚ùå –ö–ª–æ–Ω–∏—Ä—É–µ–º habits-client..."
              git clone https://github.com/andreyDanilenko/habits-client.git .
            else
              echo "‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º habits-client..."
              git fetch --all
              git reset --hard origin/master 2>/dev/null || git reset --hard origin/main
              git pull origin master 2>/dev/null || git pull origin/main
            fi
            
            echo "=== –û–±–Ω–æ–≤–ª—è–µ–º go-angular-pg —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ==="
            mkdir -p ${{ env.PROJECT_DIR }}/${{ env.GO_ANGULAR_DIR }}
            cd ${{ env.PROJECT_DIR }}/${{ env.GO_ANGULAR_DIR }}
            if [ ! -d ".git" ]; then
              echo "‚ùå –ö–ª–æ–Ω–∏—Ä—É–µ–º go-angular-pg..."
              git clone https://github.com/andreyDanilenko/go-angular-pg.git .
            else
              echo "‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º go-angular-pg..."
              git fetch --all
              git reset --hard origin/master 2>/dev/null || git reset --hard origin/main
              git pull origin master 2>/dev/null || git pull origin/main
            fi
            
            echo "=== –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã ==="
            cd ${{ env.PROJECT_DIR }}/${{ env.DEPLOY_DIR }}
            
            if [ -f "docker-compose.yml" ]; then
              echo "–°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
              docker-compose down
              export DOCKER_BUILDKIT=1
              docker-compose build --no-cache
              docker-compose up -d
              
              echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
              docker-compose ps
              
              echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ nginx..."
              docker-compose logs --tail=50 nginx
              
              echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –∑–∞–ø—É—â–µ–Ω—ã"
            else
              echo "‚ö†Ô∏è docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
              ls -la
            fi
            
            echo "=== –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
            # –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker container prune -f
            # –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ)
            docker image prune -a -f
            # –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ç–∏
            docker network prune -f
            # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ volumes (postgres_data –æ—Å—Ç–∞—ë—Ç—Å—è, —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
            docker volume prune -f
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
            echo "–û—Å—Ç–∞–≤—à–∏–µ—Å—è volumes:"
            docker volume ls
            
            echo "=== –ü—Ä–æ–≤–µ—Ä—è–µ–º volumes ==="
            docker volume ls | grep postgres_data
            
            echo "=== –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤ ==="
            echo "Article Service:"
            curl -I https://lifedream.tech || echo "–ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
            
            echo "Habits Service:"
            curl -I https://habits.lifedream.tech || echo "–ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
            
            echo "=== –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω ==="
