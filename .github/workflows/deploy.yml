# deploy.yml
name: Deploy Infrastructure

on:
  push:
    branches:
      - master
      - main
  workflow_run:
    workflows: ["Build and Push Habits API Image"]
    types:
      - completed
  workflow_dispatch:

env:
  PROJECT_DIR: /root/project
  DEPLOY_DIR: deployment
  CLIENT_DIR: habits
  GO_ANGULAR_DIR: go-angular-pg

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout deployment repository
        uses: actions/checkout@v3
        with:
          repository: andreyDanilenko/deployment-automation
          path: deployment
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_SECRET_KEY }}
          script: |
            echo "=== Starting deployment with Docker images ==="
            
            # Создаем основную папку проекта
            mkdir -p ${{ env.PROJECT_DIR }}/${{ env.DEPLOY_DIR }}
            cd ${{ env.PROJECT_DIR }}/${{ env.DEPLOY_DIR }}
            
            # Обновляем deployment файлы
            echo "=== Updating deployment configuration ==="
            if [ ! -d ".git" ]; then
              echo "❌ Cloning deployment repository..."
              git clone https://github.com/andreyDanilenko/deployment-automation.git .
            else
              echo "✅ Updating deployment repository..."
              git pull origin master 2>/dev/null || git pull origin main
            fi
            
            # Сохраняем .env если есть
            if [ -f ".env" ]; then
              cp .env /tmp/.env.backup
              echo "✅ .env file saved"
            fi
            
            # Загружаем последние изменения
            git fetch --all
            git reset --hard origin/master 2>/dev/null || git reset --hard origin/main
            
            # Восстанавливаем .env
            if [ -f "/tmp/.env.backup" ]; then
              mv /tmp/.env.backup .env
              echo "✅ .env file restored"
            fi
            
            # === ВОССТАНАВЛИВАЕМ ОБНОВЛЕНИЕ ОСТАЛЬНЫХ РЕПОЗИТОРИЕВ ===
            
            echo "=== Updating habits-client repository ==="
            mkdir -p ${{ env.PROJECT_DIR }}/${{ env.CLIENT_DIR }}
            cd ${{ env.PROJECT_DIR }}/${{ env.CLIENT_DIR }}
            if [ ! -d ".git" ]; then
              echo "❌ Cloning habits-client..."
              git clone https://github.com/andreyDanilenko/habits-client.git .
            else
              echo "✅ Updating habits-client..."
              git fetch --all
              git reset --hard origin/master 2>/dev/null || git reset --hard origin/main
              git pull origin master 2>/dev/null || git pull origin main
            fi
            
            echo "=== Updating go-angular-pg repository ==="
            mkdir -p ${{ env.PROJECT_DIR }}/${{ env.GO_ANGULAR_DIR }}
            cd ${{ env.PROJECT_DIR }}/${{ env.GO_ANGULAR_DIR }}
            if [ ! -d ".git" ]; then
              echo "❌ Cloning go-angular-pg..."
              git clone https://github.com/andreyDanilenko/go-angular-pg.git .
            else
              echo "✅ Updating go-angular-pg..."
              git fetch --all
              git reset --hard origin/master 2>/dev/null || git reset --hard origin/main
              git pull origin master 2>/dev/null || git pull origin main
            fi
            
            # Возвращаемся в папку deployment для запуска контейнеров
            cd ${{ env.PROJECT_DIR }}/${{ env.DEPLOY_DIR }}
            
            # Обновляем образы и перезапускаем контейнеры
            echo "=== Pulling latest Docker images ==="
            docker-compose pull habits_api
            
            echo "=== Recreating containers ==="
            # Останавливаем все контейнеры
            docker-compose down
            
            # Запускаем все контейнеры заново
            # habits_api использует образ из Docker Hub
            # Остальные собираются из локального кода
            export DOCKER_BUILDKIT=1
            docker-compose up -d --build
            
            # Проверяем статус
            echo "=== Checking containers status ==="
            docker-compose ps
            
            echo "=== Checking habits_api logs ==="
            docker-compose logs --tail=50 habits_api
            
            echo "=== Checking nginx logs ==="
            docker-compose logs --tail=50 nginx
            
            echo "=== Checking service availability ==="
            echo "Article Service:"
            curl -I https://lifedream.tech || echo "Not available"
            
            echo "Habits Service:"
            curl -I https://habits.lifedream.tech/api/health || echo "⚠️ Health check failed"
            
            echo "=== Checking volumes ==="
            docker volume ls | grep postgres_data
            
            echo "=== Deployment completed ==="
